defmodule EntryGenesis do
    @signer <<140, 27, 75, 245, 48, 112, 140, 244, 78, 114, 11, 45, 8, 201, 199,
         184, 71, 69, 96, 112, 52, 204, 31, 56, 143, 115, 222, 87, 7, 185, 3, 168,
         252, 90, 91, 114, 16, 244, 47, 228, 198, 82, 12, 130, 10, 126, 118, 193>>
    @pop <<175, 176, 86, 129, 118, 228, 182, 86, 225, 187, 236, 131, 170, 81, 121, 174,
         164, 44, 71, 123, 136, 151, 170, 187, 43, 43, 211, 181, 163, 103, 93, 122,
         11, 207, 92, 1, 190, 71, 46, 129, 210, 134, 62, 169, 152, 161, 189, 58, 18,
         246, 6, 151, 128, 196, 116, 93, 20, 204, 153, 217, 81, 205, 1, 133, 65, 204,
         177, 138, 74, 8, 104, 109, 214, 59, 245, 51, 47, 218, 15, 207, 190, 73, 40,
         128, 108, 147, 250, 88, 241, 61, 129, 47, 189, 173, 118, 76>>
    @attestation %{
       signature: <<150, 128, 151, 211, 81, 2, 22, 189, 192, 248, 220, 64, 197, 240,
         148, 17, 219, 219, 4, 229, 133, 201, 250, 93, 88, 124, 30, 191, 34, 116,
         233, 24, 219, 181, 139, 19, 116, 250, 113, 254, 96, 255, 40, 140, 108, 223,
         249, 213, 1, 71, 114, 81, 221, 82, 169, 176, 220, 157, 166, 53, 238, 49,
         233, 183, 138, 154, 46, 187, 86, 238, 94, 3, 193, 180, 217, 231, 114, 236,
         4, 22, 32, 18, 74, 39, 155, 100, 101, 188, 177, 76, 228, 245, 190, 246,
         141, 4>>,
       mutations_hash: <<72, 67, 216, 106, 224, 102, 200, 77, 84, 86, 71, 38, 221,
         89, 178, 87, 170, 13, 141, 117, 29, 103, 251, 177, 92, 143, 88, 218, 21,
         177, 139, 196>>,
       signer: <<140, 27, 75, 245, 48, 112, 140, 244, 78, 114, 11, 45, 8, 201, 199,
         184, 71, 69, 96, 112, 52, 204, 31, 56, 143, 115, 222, 87, 7, 185, 3, 168,
         252, 90, 91, 114, 16, 244, 47, 228, 198, 82, 12, 130, 10, 126, 118, 193>>,
       entry_hash: <<120, 90, 181, 68, 208, 238, 7, 192, 206, 119, 160, 164, 226,
         206, 103, 148, 111, 194, 6, 249, 110, 107, 175, 210, 15, 48, 173, 152, 134,
         224, 37, 235>>
     }
    @genesis_entry %{
       header: <<131, 116, 0, 0, 0, 8, 119, 2, 100, 114, 109, 0, 0, 0, 32, 84, 159,
         218, 148, 3, 74, 21, 222, 110, 149, 236, 143, 28, 214, 195, 44, 220, 170,
         130, 199, 176, 231, 227, 192, 91, 107, 204, 118, 148, 35, 220, 89, 119, 6,
         104, 101, 105, 103, 104, 116, 97, 0, 119, 9, 112, 114, 101, 118, 95, 104,
         97, 115, 104, 109, 0, 0, 0, 0, 119, 9, 112, 114, 101, 118, 95, 115, 108,
         111, 116, 98, 255, 255, 255, 255, 119, 6, 115, 105, 103, 110, 101, 114,
         109, 0, 0, 0, 48, 140, 27, 75, 245, 48, 112, 140, 244, 78, 114, 11, 45, 8,
         201, 199, 184, 71, 69, 96, 112, 52, 204, 31, 56, 143, 115, 222, 87, 7, 185,
         3, 168, 252, 90, 91, 114, 16, 244, 47, 228, 198, 82, 12, 130, 10, 126, 118,
         193, 119, 4, 115, 108, 111, 116, 97, 0, 119, 8, 116, 120, 115, 95, 104, 97,
         115, 104, 109, 0, 0, 0, 32, 175, 19, 73, 185, 245, 249, 161, 166, 160, 64,
         77, 234, 54, 220, 201, 73, 155, 203, 37, 201, 173, 193, 18, 183, 204, 154,
         147, 202, 228, 31, 50, 98, 119, 2, 118, 114, 109, 0, 0, 0, 96, 140, 231,
         248, 141, 33, 27, 83, 165, 26, 20, 127, 81, 176, 209, 39, 115, 201, 117,
         35, 148, 245, 72, 104, 235, 255, 248, 224, 25, 120, 227, 49, 255, 144, 173,
         88, 168, 123, 192, 92, 236, 58, 36, 141, 252, 83, 54, 154, 250, 12, 112,
         140, 194, 118, 203, 194, 161, 99, 218, 180, 197, 139, 0, 126, 214, 49, 227,
         12, 206, 34, 39, 152, 22, 76, 18, 252, 153, 79, 223, 4, 145, 1, 93, 79,
         166, 218, 232, 91, 101, 253, 108, 160, 54, 148, 64, 179, 197>>,
       signature: <<175, 216, 29, 214, 64, 173, 66, 11, 37, 215, 67, 157, 191, 187,
         30, 38, 93, 134, 179, 41, 240, 252, 79, 60, 141, 9, 80, 39, 124, 99, 185,
         159, 161, 188, 78, 211, 169, 10, 144, 133, 240, 135, 253, 160, 223, 85,
         168, 123, 6, 205, 131, 183, 41, 13, 107, 70, 24, 45, 43, 15, 231, 181, 214,
         67, 250, 4, 71, 62, 243, 201, 45, 183, 221, 215, 219, 237, 94, 89, 26, 41,
         19, 19, 207, 233, 162, 34, 33, 182, 155, 144, 229, 179, 88, 202, 95, 48>>,
       hash: <<120, 90, 181, 68, 208, 238, 7, 192, 206, 119, 160, 164, 226, 206,
         103, 148, 111, 194, 6, 249, 110, 107, 175, 210, 15, 48, 173, 152, 134, 224,
         37, 235>>,
       header_unpacked: %{
         slot: 0,
         height: 0,
         signer: <<140, 27, 75, 245, 48, 112, 140, 244, 78, 114, 11, 45, 8, 201,
           199, 184, 71, 69, 96, 112, 52, 204, 31, 56, 143, 115, 222, 87, 7, 185, 3,
           168, 252, 90, 91, 114, 16, 244, 47, 228, 198, 82, 12, 130, 10, 126, 118,
           193>>,
         dr: <<84, 159, 218, 148, 3, 74, 21, 222, 110, 149, 236, 143, 28, 214, 195,
           44, 220, 170, 130, 199, 176, 231, 227, 192, 91, 107, 204, 118, 148, 35,
           220, 89>>,
         vr: <<140, 231, 248, 141, 33, 27, 83, 165, 26, 20, 127, 81, 176, 209, 39,
           115, 201, 117, 35, 148, 245, 72, 104, 235, 255, 248, 224, 25, 120, 227,
           49, 255, 144, 173, 88, 168, 123, 192, 92, 236, 58, 36, 141, 252, 83, 54,
           154, 250, 12, 112, 140, 194, 118, 203, 194, 161, 99, 218, 180, 197, 139,
           0, 126, 214, 49, 227, 12, 206, 34, 39, 152, 22, 76, 18, 252, 153, 79,
           223, 4, 145, 1, 93, 79, 166, 218, 232, 91, 101, 253, 108, 160, 54, 148,
           64, 179, 197>>,
         prev_hash: "",
         prev_slot: -1,
         txs_hash: <<175, 19, 73, 185, 245, 249, 161, 166, 160, 64, 77, 234, 54,
           220, 201, 73, 155, 203, 37, 201, 173, 193, 18, 183, 204, 154, 147, 202,
           228, 31, 50, 98>>
       },
       txs: []
     }

    def signer() do
        @signer
    end

    def pop() do
        @pop
    end

    def attestation() do
        @attestation
    end
    
    def get() do
        @genesis_entry
    end

    def generate() do
        pk = Application.fetch_env!(:ama, :trainer_pk)
        sk = Application.fetch_env!(:ama, :trainer_sk)

        entropy_seed = """
        January 22, 2025

        Rovertech Sets New Landmine Clearing Record
        """
        dr = Blake3.hash(entropy_seed)
        vr = BlsEx.sign!(sk, dr<>dr<>dr, BLS12AggSig.dst_vrf())

        entry = %{
          header_unpacked: %{
            slot: 0,
            height: 0,
            prev_slot: -1,
            prev_hash: <<>>,
            dr: dr,
            vr: vr,
            signer: pk,
          },
          txs: [],
        }
        entry_signed = Entry.sign(entry)

        %{db: db, cf: cf} = :persistent_term.get({:rocksdb, Fabric})
        {:ok, rtx} = :rocksdb.transaction(db, [])
        Process.put({RocksDB, :ctx}, %{rtx: rtx, cf: cf})
        {mutations, _} = BIC.Base.call_exit(%{entry: entry})

        mutations_hash = ConsensusKV.hash_mutations(mutations)
        attestation = Attestation.sign(entry_signed.hash, mutations_hash)

        pop = BlsEx.sign!(sk, pk, BLS12AggSig.dst_pop())
        entry_signed = Entry.pack(entry_signed) |> Entry.unpack()

        IO.inspect {entry_signed, attestation, pop}, limit: :infinity
        :ok
    end
end
