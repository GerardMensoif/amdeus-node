defmodule EntryGenesis do
    @signer <<140, 27, 75, 245, 48, 112, 140, 244, 78, 114, 11, 45, 8, 201, 199,
         184, 71, 69, 96, 112, 52, 204, 31, 56, 143, 115, 222, 87, 7, 185, 3, 168,
         252, 90, 91, 114, 16, 244, 47, 228, 198, 82, 12, 130, 10, 126, 118, 193>>
    @pop <<135, 180, 75, 178, 14, 91, 236, 217, 129, 202, 248, 118, 0, 46, 44, 68, 238,
         161, 45, 45, 149, 39, 57, 179, 230, 191, 16, 105, 166, 48, 184, 195, 142, 87,
         62, 48, 216, 87, 50, 165, 121, 91, 84, 172, 185, 197, 85, 5, 9, 198, 1, 46,
         185, 34, 191, 196, 176, 67, 109, 243, 254, 188, 0, 115, 172, 161, 136, 101,
         48, 101, 232, 51, 142, 104, 145, 57, 54, 63, 52, 249, 242, 82, 123, 32, 114,
         184, 155, 207, 150, 80, 170, 119, 59, 168, 205, 206>>
    @attestation %{
       signature: <<137, 134, 227, 220, 215, 63, 245, 7, 51, 101, 230, 55, 194, 99,
         74, 152, 159, 112, 93, 92, 128, 183, 226, 58, 35, 201, 117, 1, 175, 75,
         141, 36, 91, 209, 166, 147, 112, 59, 119, 247, 114, 114, 78, 242, 5, 123,
         69, 163, 23, 157, 90, 236, 203, 71, 231, 158, 200, 176, 188, 93, 88, 156,
         107, 149, 75, 234, 129, 36, 234, 193, 31, 156, 248, 103, 177, 104, 192,
         163, 113, 207, 198, 3, 3, 11, 196, 67, 88, 127, 127, 59, 25, 107, 218, 223,
         186, 215>>,
       entry_hash: <<255, 1, 220, 21, 44, 71, 41, 240, 89, 9, 202, 207, 77, 242,
         150, 12, 218, 127, 121, 24, 215, 197, 78, 138, 171, 244, 137, 48, 121, 161,
         182, 247>>,
       mutations_hash: <<66, 149, 1, 55, 146, 112, 219, 251, 7, 29, 14, 192, 64,
         137, 111, 3, 133, 34, 24, 191, 166, 108, 112, 137, 165, 212, 85, 159, 143,
         37, 171, 46>>,
       signer: <<140, 27, 75, 245, 48, 112, 140, 244, 78, 114, 11, 45, 8, 201, 199,
         184, 71, 69, 96, 112, 52, 204, 31, 56, 143, 115, 222, 87, 7, 185, 3, 168,
         252, 90, 91, 114, 16, 244, 47, 228, 198, 82, 12, 130, 10, 126, 118, 193>>
     }
    @genesis_entry %{
       header: <<131, 116, 0, 0, 0, 8, 119, 2, 100, 114, 109, 0, 0, 0, 32, 84, 159,
         218, 148, 3, 74, 21, 222, 110, 149, 236, 143, 28, 214, 195, 44, 220, 170,
         130, 199, 176, 231, 227, 192, 91, 107, 204, 118, 148, 35, 220, 89, 119, 6,
         104, 101, 105, 103, 104, 116, 97, 0, 119, 9, 112, 114, 101, 118, 95, 104,
         97, 115, 104, 109, 0, 0, 0, 0, 119, 9, 112, 114, 101, 118, 95, 115, 108,
         111, 116, 98, 255, 255, 255, 255, 119, 6, 115, 105, 103, 110, 101, 114,
         109, 0, 0, 0, 48, 140, 27, 75, 245, 48, 112, 140, 244, 78, 114, 11, 45, 8,
         201, 199, 184, 71, 69, 96, 112, 52, 204, 31, 56, 143, 115, 222, 87, 7, 185,
         3, 168, 252, 90, 91, 114, 16, 244, 47, 228, 198, 82, 12, 130, 10, 126, 118,
         193, 119, 4, 115, 108, 111, 116, 97, 0, 119, 8, 116, 120, 115, 95, 104, 97,
         115, 104, 109, 0, 0, 0, 32, 175, 19, 73, 185, 245, 249, 161, 166, 160, 64,
         77, 234, 54, 220, 201, 73, 155, 203, 37, 201, 173, 193, 18, 183, 204, 154,
         147, 202, 228, 31, 50, 98, 119, 2, 118, 114, 109, 0, 0, 0, 96, 160, 142,
         114, 51, 82, 135, 127, 114, 49, 187, 196, 113, 170, 147, 87, 133, 250, 217,
         173, 223, 120, 136, 226, 6, 232, 252, 138, 41, 2, 105, 219, 45, 87, 15, 19,
         247, 136, 62, 79, 140, 135, 252, 21, 39, 43, 25, 180, 1, 3, 163, 28, 106,
         248, 63, 107, 43, 93, 242, 175, 39, 211, 174, 54, 227, 115, 151, 188, 203,
         103, 90, 43, 17, 198, 199, 219, 218, 217, 20, 208, 66, 7, 182, 47, 238,
         164, 43, 123, 168, 138, 73, 49, 108, 122, 39, 202, 25>>,
       signature: <<167, 219, 224, 251, 59, 97, 125, 155, 127, 35, 204, 108, 214,
         54, 218, 58, 157, 200, 243, 234, 14, 31, 106, 245, 190, 136, 140, 176, 56,
         57, 70, 12, 77, 19, 153, 198, 49, 216, 206, 91, 159, 176, 75, 141, 71, 45,
         14, 170, 3, 29, 131, 148, 207, 28, 112, 118, 201, 187, 71, 228, 221, 116,
         168, 24, 153, 250, 167, 164, 45, 237, 72, 206, 132, 5, 74, 100, 164, 88,
         228, 159, 94, 62, 56, 255, 37, 99, 241, 126, 113, 209, 133, 121, 175, 50,
         187, 203>>,
       hash: <<255, 1, 220, 21, 44, 71, 41, 240, 89, 9, 202, 207, 77, 242, 150, 12,
         218, 127, 121, 24, 215, 197, 78, 138, 171, 244, 137, 48, 121, 161, 182,
         247>>,
       header_unpacked: %{
         slot: 0,
         signer: <<140, 27, 75, 245, 48, 112, 140, 244, 78, 114, 11, 45, 8, 201,
           199, 184, 71, 69, 96, 112, 52, 204, 31, 56, 143, 115, 222, 87, 7, 185, 3,
           168, 252, 90, 91, 114, 16, 244, 47, 228, 198, 82, 12, 130, 10, 126, 118,
           193>>,
         height: 0,
         vr: <<160, 142, 114, 51, 82, 135, 127, 114, 49, 187, 196, 113, 170, 147,
           87, 133, 250, 217, 173, 223, 120, 136, 226, 6, 232, 252, 138, 41, 2, 105,
           219, 45, 87, 15, 19, 247, 136, 62, 79, 140, 135, 252, 21, 39, 43, 25,
           180, 1, 3, 163, 28, 106, 248, 63, 107, 43, 93, 242, 175, 39, 211, 174,
           54, 227, 115, 151, 188, 203, 103, 90, 43, 17, 198, 199, 219, 218, 217,
           20, 208, 66, 7, 182, 47, 238, 164, 43, 123, 168, 138, 73, 49, 108, 122,
           39, 202, 25>>,
         dr: <<84, 159, 218, 148, 3, 74, 21, 222, 110, 149, 236, 143, 28, 214, 195,
           44, 220, 170, 130, 199, 176, 231, 227, 192, 91, 107, 204, 118, 148, 35,
           220, 89>>,
         prev_hash: "",
         prev_slot: -1,
         txs_hash: <<175, 19, 73, 185, 245, 249, 161, 166, 160, 64, 77, 234, 54,
           220, 201, 73, 155, 203, 37, 201, 173, 193, 18, 183, 204, 154, 147, 202,
           228, 31, 50, 98>>
       },
       txs: []
     }

    def signer() do
        @signer
    end

    def pop() do
        @pop
    end

    def attestation() do
        @attestation
    end
    
    def get() do
        @genesis_entry
    end

    def generate() do
        pk_raw = Application.fetch_env!(:ama, :trainer_pk_raw)
        sk_raw = Application.fetch_env!(:ama, :trainer_sk_raw)

        entropy_seed = """
        aefeafeafeafefaefa
        """
        dr_raw = Blake3.hash(entropy_seed)
        vr_raw = BlsEx.sign!(sk_raw, dr_raw<>dr_raw<>dr_raw)

        entry = %{
          header_unpacked: %{
            slot: 0,
            height: 0,
            prev_slot: -1,
            prev_hash: <<>>,
            dr: dr_raw,
            vr: vr_raw,
            signer: pk_raw,
          },
          txs: [],
        }
        entry_signed = Entry.sign(entry)

        %{db: db, cf: cf} = :persistent_term.get({:rocksdb, Fabric})
        {:ok, rtx} = :rocksdb.transaction(db, [])
        Process.put({RocksDB, :ctx}, %{rtx: rtx, cf: cf})
        {mutations, _} = BIC.Base.call_exit(%{entry: entry})

        mutations_hash = ConsensusKV.hash_mutations(mutations)
        attestation = Attestation.sign(entry_signed.hash, mutations_hash)

        pop = BlsEx.sign!(sk_raw, pk_raw)
        entry_signed = Entry.pack(entry_signed) |> Entry.unpack()

        IO.inspect {entry_signed, attestation, pop}, limit: :infinity
        :ok
    end
end
